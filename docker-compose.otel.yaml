# OpenTelemetry Collector + ClickHouse (metrics only, exports to ClickHouse, NOT Prometheus).
# Run: docker compose -f docker-compose.otel.yaml up -d
# Then set OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318 and start the broker.
# If 8123/9000 are in use, change the left-hand side (e.g. "18123:8123", "19000:9000").

services:
  clickhouse:
    image: clickhouse/clickhouse-server:24
    container_name: cex-broker-clickhouse
    ports:
      - "18123:8123"   # HTTP (queries). Use "18123:8123" if 8123 is taken.
      - "19000:9000"   # Native TCP (collector). Use "19000:9000" if 9000 is taken.
    environment:
      CLICKHOUSE_DB: otel
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8123/ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.112.0
    container_name: cex-broker-otel-collector
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - ./otel/collector-config.yaml:/etc/otelcol/config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP (broker sends here)
    depends_on:
      clickhouse:
        condition: service_healthy

volumes:
  clickhouse_data:
